<!DOCTYPE html>
<html lang=pt-br">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Localizacao | Point</title>
  <link rel="stylesheet" href="css/styleDash.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
  <script src="./jsDash/leaftlet.js"></script>
  <script src="./jsDash/heatmap.js"></script>
  <script src="./jsDash/leaflet-heat.js"></script>
</head>

<body>
  <header>
    <nav id="menu">
      <a href="maquinas.html" class="logo">
        <img src="../assets/imgs/Point.png">
      </a>
      <hr>
      <a href="funcionarios.html" class="img-nav">
        <img src="../assets/imgs/user.png">
        <span>Funcionários</span>
      </a>
      <a href="maquinas.html" class="img-nav">
        <img src="./assets/imgs/imac.png">
        <span>Máquinas</span>
      </a>
      <a href="instancias.html" class="img-nav">
        <img src="assets/dash/server.png">
        <span>Instâncias</span>
      </a>
      <a href="alertas.html" class="img-nav">
        <img src="assets/dash/alertas.png">
        <span>Alertas</span>
      </a>
      <a href="localizacao.html" class="img-nav">
        <img src="assets/imgs/pin.png">
        <span>Localização</span>
      </a>
      <a href="configuracoes.html" class="img-nav">
        <img src="./assets/imgs/setting.png">
        <span>Configurações</span>
      </a>
      <hr>
      <a class="img-nav" id="sair">
        <img src="../assets/imgs/x.png" />
        <span>Sair</span>
      </a>
    </nav>
    <nav id="menu-mobile"><img src="assets/dash/bars.svg"></nav>
  </header>
  <main>

    <div class="main-localizacao">

      <div class="left-wid">

        <div class="titulo">
          <p>Localização das máquinas</p>
        </div>

        <div class="filtro">
        <div class="dropdown">
          <div class="select">
            <span>Preferências</span>
            <i class="fa fa-chevron-left"></i>
          </div>
          <input type="hidden" name="gender" id="new_plano">
          <ul class="dropdown-menu">
            <li id="3">Todas as Máquinas</li>
            <li id="2">Servidor</li>
            <li id="1">Desktop</li>
            <li id="1">?????</li>
            <li id="1">?????</li>
            <li id="1">?????</li>
            <li id="1">?????</li>
            <li id="1">?????</li>
            <li id="1">?????</li>
            <li id="1">?????</li>
          </ul>
        </div>
        <button class="custom-btn btn-8" onclick="alterarHeat()">Filtrar</button>
      </div>
        <div class="heatmap" id="map">

        </div>
      </div>


      <div class="rigth-wid">

        <div class="wordcloud">

          <canvas id="myChart"></canvas>


        </div>

        <div class="table">

          <ul id="lista">
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>
            <li><a href="">
                <p>São Paulo</p>
                <p>BR</p>
            </li></a>

          </ul>

        </div>
      </div>
    </div>

  </main>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="../script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>

    //IMPORTANT: As medidas de Latitude e Longitude foram trocadas no banco então o select que pega a localizacao com lat e long é 
    // Vice versa. Então no código está tudo Trocado


    /* TODO: Colocar o select pra pegar os dados de Longitude e Latitude
          Passar como parametro da página para o tipo de filtro no Maap 
    */
    function pegarDadosMapa(){
      fetch(`/mapaIvan/getLocalizacao?idEmpresa=${sessionStorage.ID_EMPRESA}`).
      then(function(resposta) {

        if (resposta.ok){

          resposta.json().then((resposta) => {

          gerarMapa(resposta)
            
          });
          
        }

      })
    }


    function listarCidades(){


    }

    function gerarMapa(jsonObj) {
  
      // TODO: Pegar o valor máximo que a parada aparece pra deixar no max para ter um equilibrio
      var maximoValores = 0

      jsonObj.forEach(i => {

        var count =0;

        jsonObj.forEach(j =>{

          if(i['latitude'] == j['latitude'] && i['longitude'] == j['longitude']){
            count++;
          }

          if(count >= maximoValores){
            maximoValores = count;
          }

        });
      });

      console.log(maximoValores)

      var testData = {
        // Quanto mais próximo do maximo fica com red dot
        max: maximoValores,
        data: jsonObj
      };

      var mediaLat = 0;
      var mediaLng = 0;
      tamanhoData = jsonObj.length;

      for (let i = 0; i < tamanhoData; i++) {
        mediaLat += Number(jsonObj[i]['latitude']);
        mediaLng += Number(jsonObj[i]["longitude"]);
      }

      mediaLat /= tamanhoData;
      mediaLng /= tamanhoData;


      var baseLayer = L.tileLayer(
        "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          attribution:
            'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
          maxZoom: 10,

        }
      );

      console.log(jsonObj)
      var cfg = {
    
        radius: 0.2,
        maxOpacity: 0.5,

        scaleRadius: true,
 
        useLocalExtrema: false,
 
        latField: "longitude",

        lngField: "latitude",
       
        valueField: "count",
      };

      var heatmapLayer = new HeatmapOverlay(cfg);
      var map = new L.Map("map", {
        center: new L.LatLng(mediaLng, mediaLat),
        zoom: 3,
        layers: [baseLayer, heatmapLayer],
      });

      heatmapLayer.setData(testData);
      // make accessible for debugging
      layer = heatmapLayer;


    };

    
    pegarDadosMapa()
  
  </script>
  <script src="./jsDash/script-dash.js"></script>

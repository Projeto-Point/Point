<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rede | Point</title>
    <link rel="stylesheet" href="css/styleDashRede.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>

<body>
    <header>
        <nav id="menu">
            <a href="maquinas.html" class="logo">
                <img src="../assets/imgs/Point.png">
            </a>
            <hr>
            <a href="funcionarios.html" class="img-nav">
                <img src="../assets/imgs/user.png">
                <span>Funcionários</span>
            </a>
            <a href="maquinas.html" class="img-nav">
                <img src="./assets/imgs/imac.png">
                <span>Máquinas</span>
            </a>
            <a href="instancias.html" class="img-nav">
                <img src="assets/dash/server.png">
                <span>Instâncias</span>
            </a>
            <a href="alertas.html" class="img-nav">
                <img src="assets/dash/alertas.png">
                <span>Alertas</span>
            </a>
            <a href="localizacao.html" class="img-nav">
                <img src="assets/imgs/pin.png">
                <span>Localização</span>
            </a>
            <a href="configuracoes.html" class="img-nav">
                <img src="./assets/imgs/setting.png">
                <span>Configurações</span>
            </a>
            <hr>
            <a class="img-nav" id="sair">
                <img src="../assets/imgs/x.png" />
                <span>Sair</span>
            </a>
        </nav>
        <nav id="menu-mobile"><img src="assets/dash/bars.svg" /></nav>
    </header>
    <main>
        <section class="top">
            <div class="top-esq">
                <p class="titulo">Olá, <span id="nome_gerente"></span></p>
                <p class="subtitulo">17/10/2022</p>
            </div>
            <div class="top-meio" style="visibility: hidden">
                <input id="inp-pesquisar-funcionario" type="search"
                    placeholder="Pesquise o nome de um funcionário..." />
            </div>
            <div class="top-dir">
                <p class="nome"><span id="nomeGerente"></span></p>
                <img src="../assets/dash/icons8-user-64.png" />
            </div>
        </section>
        <section class="dashboard-analise">
            <div class="box box-kpi kpi-horas">
                <h3>Horas ativas:</h3>
                <p id="kpiHoras"></p>
            </div>
            <div class="box box-kpi kpi-mediaProc">
                <h3>Média de Dowload:</h3>
                <p id="kpiCPU">%</p>
            </div>
            <div class="box box-kpi kpi-mediaRam">
                <h3>Média de Upload:</h3>
                <p id="kpiRAM">%</p>
            </div>
            <div class="tempo-real-rede">
                <div class="tempo-real-dowload" id="gfCpu">
                    <h3 class="h3Rede">Download</h3>
                    <div> <canvas id="graficoCPU" style="position: relative;"></canvas></div>
                </div>
                <div class="tempo-real-upload" id="gfRam">
                    <h3 class="h3Rede">Upload</h3>
                    <canvas id="graficoRAM" style="position: relative;"></canvas>
                </div>
                <div class="main-grafico">
                    <canvas id="graficoCPU"></canvas>
                </div>
            </div>
            <div class="grafico-ram grafico box">
                <div class="header">
                    <h3>Download</h3>
                    <div class="dir">
                        <div class="legenda alto"></div>
                        <span>Maior que 85%</span>
                        <div class="legenda normal"></div>
                        <span>Menor que 85%</span>
                        <select id="tempoDowload" onchange="mudarTempo('Dowload', this.value)">
                            <option value="ultimoMes">Último mês</option>
                            <option value="ultimaSemana">Última semana</option>
                            <option value="ultimoAno">Último ano</option>
                        </select>
                    </div>
                </div>
                <div class="main-grafico">
                    <canvas id="graficoRAM"></canvas>
                </div>
            </div>
            <div class="grafico-disco grafico box">
                <div class="header">
                    <h3>Upload</h3>
                    <div class="dir">
                        <div class="legenda alto"></div>
                        <span>Maior que 90%</span>
                        <div class="legenda normal"></div>
                        <span>Menor que 90%</span>
                        <select id="tempoDisco" onchange="mudarTempo('Disco', this.value)">
                            <option value="ultimoMes">Último mês</option>
                            <option value="ultimaSemana">Última semana</option>
                            <option value="ultimoAno">Último ano</option>
                        </select>
                    </div>
                </div>
                <div class="main-grafico">
                    <canvas id="graficoDisco"></canvas>
                </div>
            </div>

            <div class="box info-funcionario" id="sobreFuncionario">
                <h3>Sobre o funcionário</h3>
            </div>
            <div class="box info-maquina" id="sobreMaquina">
                <h3>Sobre a máquina</h3>
            </div>
        </section>
    </main>
</body>

</html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="../script.js"></script>
<script>
    /*tempo real*/

    /*analise*/
    nomeGerente.innerHTML = sessionStorage.NOME_USUARIO;
    nome_gerente.innerHTML = sessionStorage.NOME_USUARIO;

    const parametrosString = window.location.search;
    const parametros = new URLSearchParams(parametrosString);
    const idMaquinaA = Number(parametros.get("idMaquina"));

    fetch(`/medidas/pegarRegistroMaquina?idMaquina=${idMaquinaA}`).then((res) => {
        if (res.ok) {
            res.json().then((resposta) => {
                document.getElementById(
                    "sobreMaquina"
                ).innerHTML += `<p><b>Sistema operacional: </b><span>${resposta[0].sistemaOperacional}</span></p>`;
                document.getElementById(
                    "sobreMaquina"
                ).innerHTML += `<p><b>Nome da máquina: </b><span>${resposta[0].nomeMaquina}</span></p>`;
                document.getElementById(
                    "sobreMaquina"
                ).innerHTML += `<p><b>Tipo da máquina: </b><span>${resposta[0].tipoMaquina}</span></p>`;


                for (let index = 0; index < resposta.length; index++) {
                    if (resposta[index].atributo == "CORE") {
                        resposta[index].unidadeMedida = "";
                        resposta[index].valor *= 1;
                        Math.trunc(resposta[index].valor);
                    }
                    if (resposta[index].atributo == "THREADS") {
                        resposta[index].unidadeMedida = "";
                        resposta[index].valor *= 1;
                        Math.trunc(resposta[index].valor);
                    }
                    document.getElementById(
                        "sobreMaquina"
                    ).innerHTML += `<p><b>${resposta[index].tipoComponente} - ${resposta[index].atributo}: </b><span>${resposta[index].valor} ${resposta[index].unidadeMedida}</span></p>`;
                }
            });
        }
    });

    fetch(`/medidas/pegarRegistroFuncionario?idMaquina=${idMaquinaA}`).then(
        function (res) {
            if (res.ok) {
                res.json().then((resposta) => {
                    sobreFuncionario.innerHTML += `<p><b>Nome: </b>${resposta[0].nome}</p>`;
                    sobreFuncionario.innerHTML += `<p><b>Cargo: </b>${resposta[0].cargo}</p>`;
                    sobreFuncionario.innerHTML += `<p><b>E-mail: </b>${resposta[0].email}</p>`;
                    sobreFuncionario.innerHTML += `<p><b>Telefone: </b>${resposta[0].telefone}</p>`;
                });
            }
        }
    );

    fetch(`/maquinas/pegarKpis?idMaquina=${idMaquinaA}&dataInicio=${moment().subtract(30, "days").format("YYYY-MM-DD")}&dataFinal=${moment().format("YYYY-MM-DD")}`)
        .then((res) => {
            if (res.ok) {
                res.json().then((resposta) => {
                    console.log(resposta)
                    kpiCPU.innerHTML = resposta[0].mediaProcessador + "%";
                    kpiRAM.innerHTML = resposta[0].mediaRAM + "%";
                });
            }
        })
        .catch((erro) => {
            console.log("Erro ao acessar /maquinas/pegarKpis");
            console.log(erro);
        });

    fetch(`/maquinas/pegarTempo?idMaquina=${idMaquinaA}&dataInicio=${moment().subtract(30, "days").format("YYYY-MM-DD")}&dataFinal=${moment().format("YYYY-MM-DD")}`)
        .then((res) => {
            if (res.ok) {
                res.json().then((resposta) => {
                    let horarioEntrada;
                    let horariosDiferenca = [];

                    resposta.forEach(item => {
                        if (item.acao == "E") {
                            horarioEntrada = moment(item.horario);
                        }
                        else {
                            horariosDiferenca.push(moment(item.horario).diff(horarioEntrada));
                        }
                    });

                    let horasAtivas = 0;
                    horariosDiferenca.forEach(horario => {
                        horasAtivas += horario;
                    });

                    let horas = moment.duration(horasAtivas).hours();
                    let minutos = moment.duration(horasAtivas).minutes();

                    if (horas == 1) {
                        kpiHoras.innerHTML += horas;
                        kpiHoras.innerHTML += " hora e "
                    }
                    else if (horas > 1) {
                        kpiHoras.innerHTML += horas;
                        kpiHoras.innerHTML += " horas e "
                    }

                    if (minutos == 1) {
                        kpiHoras.innerHTML += minutos;
                        kpiHoras.innerHTML += " minuto"
                    }
                    else if (minutos > 1) {
                        kpiHoras.innerHTML += minutos;
                        kpiHoras.innerHTML += " minutos"
                    }
                });
            }
        })
        .catch((erro) => {
            console.log(erro);
        });

    var chartDown = null;
    var chartUp = null;

    mudarTempo("Down", tempoDown.value);
    mudarTempo("Up", tempoUp.value);

    function mudarTempo(componente, tempo) {
        if (chartDown != null && componente == "CPU") {
            chartDown.destroy();
        }
        else if (chartUp != null && componente == "RAM") {
            chartUp.destroy();
        }

        tipoVisualizacao = "dia";
        if (tempo == "ultimaSemana") {
            tempo = moment().subtract(7, "days");
        }
        else if (tempo == "ultimoMes") {
            tempo = moment().subtract(30, "days");
        }
        else {
            tipoVisualizacao = "mes";
            tempo = moment().subtract(1, "years");
        }
        pegarRegistros(`grafico${componente}`, componente, idMaquinaA, tempo.format("YYYY-MM-DD"), moment().format("YYYY-MM-DD"), tipoVisualizacao);
    }

    function pegarRegistros(idGrafico, tipoComponente, idMaquinaA, dataInicio, dataFinal, tipoVisualizacao) {
        fetch(`/maquinas/analiseComponente?tipoComponente=${tipoComponente}&idMaquina=${idMaquinaA}&dataInicio=${dataInicio}&dataFinal=${dataFinal}&tipoVisualizacao=${tipoVisualizacao}`)
            .then((res) => {
                if (res.ok) {
                    res.json().then((resposta) => {
                        console.log(resposta);
                        let labels = [];

                        if (tipoVisualizacao == "dia") {
                            labels = resposta.map((registro) =>
                                moment(registro.dataEhora).format("DD/MM/YYYY")
                            );
                        }
                        else {
                            labels = resposta.map((registro) =>
                                // registro.dataEhora
                                moment().locale('pt').month(1)
                            );
                        }

                        const data = {
                            labels: labels,
                            datasets: [
                                {
                                    label: "Valor médio",
                                    backgroundColor: [],
                                    data: resposta.map((registro) => registro.media),
                                },
                            ],
                        };

                        for (let index = 0; index < resposta.length; index++) {
                            if (tipoComponente == "CPU") {
                                if (resposta[index].media >= 80) {
                                    data.datasets[0].backgroundColor.push("#D0342C");
                                } else {
                                    data.datasets[0].backgroundColor.push("#00CA43");
                                }
                            } else if (tipoComponente == "RAM") {
                                if (resposta[index].media >= 85) {
                                    data.datasets[0].backgroundColor.push("#D0342C");
                                } else {
                                    data.datasets[0].backgroundColor.push("#00CA43");
                                }
                            } else if (tipoComponente == "Disco") {
                                if (resposta[index].media >= 90) {
                                    data.datasets[0].backgroundColor.push("#D0342C");
                                } else {
                                    data.datasets[0].backgroundColor.push("#00CA43");
                                }
                            }
                        }

                        const config = {
                            type: "bar",
                            data: data,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                    },
                                },
                                plugins: {
                                    legend: {
                                        display: false,
                                    },
                                },
                            },
                        };

                        if (tipoComponente == "CPU") {
                            chartCpu = new Chart(document.getElementById(idGrafico), config);
                        }
                        else if (tipoComponente == " RAM") {
                            chartRam = new Chart(document.getElementById(idGrafico), config);
                        }
                        else if (tipoComponente == "Disco") {
                            chartDisco = new Chart(document.getElementById(idGrafico), config);
                        }
                    });
                } else {
                    console.log("Erro ao conseguir os resultados!");
                }
            })
            .catch((erro) => {
                console.log("Erro ao acessar /maquinas/analiseComponente");
            });
    }

    function plotarGraficoCPU(cpuMedida) {
        const labels = [
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            '',
            ''
        ];

        const data = {
            labels: labels,
            datasets: [{
                //CPU
                label: 'CPU',
                data: cpuMedida,
                fill: true,
                borderColor: 'rgb(75, 192, 192)',

            }]
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    Animation: false,
                }
            }

        };

        window.graficoCPU = new Chart(
            document.getElementById('graficoCPU').getContext("2d"),
            config

        );
        setTimeout(() => {
            atualizarGraficoCPU(document.getElementById('graficoCPU').getContext("2d"), data)
        }, tempoAtualizacao

        )

    }

    function atualizarGraficoCPU(grafico, dados) {
        fetch(`/medidas/pegarRegistroCPU?idMaquina=${idMaquina}`).then(function (res) {
            if (res.ok) {
                res.json().then(CPU => {
                    cpuMedida = CPU.map((object) => object.valor);
                    dados.datasets[0].data = cpuMedida
                    window.graficoCPU.update();

                    proximaAtualizacao = setTimeout(() => {
                        atualizarGraficoCPU(grafico, dados);
                    }, tempoAtualizacao)

                })
            }
        })
        // console.log("ta funcionando")
    }

    function recuperarDados() {
        fetch(`/medidas/pegarRegistroDownload?idMaquina=${idMaquina}`).then(function (res) {
            if (res.ok) {
                res.json().then(CPU => {

                    console.log(CPU)
                    cpuMedida = CPU.map((object) => object.valor);
                    plotarGraficoDownload(cpuMedida);

                })
            }
        })

        fetch(`/medidas/pegarRegistroDISCO?idMaquina=${idMaquina}`).then(function (res) {
            if (res.ok) {
                res.json().then(DISCO => {

                    // console.log(DISCO)
                    discoMedida = DISCO.map((object) => object.valor);
                    discoDisponivel = 100 - discoMedida[0];
                    plotarGraficoDISCO(discoMedida);

                })
            }
        })



        fetch(`/medidas/pegarRegistroRAM?idMaquina=${idMaquina}`).then(function (res) {
            if (res.ok) {
                res.json().then(RAM => {

                    // console.log(RAM)
                    ramMedida = RAM.map((object) => object.valor);
                    plotarGraficoRAM(ramMedida);

                })
            }
        })

        fetch(`/medidas/pegarRegistroFuncionario?idMaquina=${idMaquina}`).then(function (res) {
            if (res.ok) {
                res.json().then(RegistroFuncionario => {
                    // console.log(RegistroFuncionario)

                    var nomeFuncionario = RegistroFuncionario.map((object) => object.nome);
                    var emailFuncionario = RegistroFuncionario.map((object) => object.email);
                    var cargoFuncionario = RegistroFuncionario.map((object) => object.cargo);
                    var telefoneFuncionario = RegistroFuncionario.map((object) => object.telefone);

                    nome.innerHTML = nomeFuncionario;
                    mail.innerHTML = emailFuncionario
                    cargo.innerHTML = cargoFuncionario;
                    telefone.innerHTML = telefoneFuncionario;

                })
            }
        });

        fetch(`/medidas/pegarRegistroMaquina?idMaquina=${idMaquina}`).then((res) => {
            if (res.ok) {
                res.json().then((resposta) => {
                    //     <p><b>Sistema operacional: </b><span><div id="sistemaOp"></div></span></p>
                    // <p><b>Sistema operacional: </b><span><div id="nomeMaquina"></div></span></p>
                    // <p><b>Sistema operacional: </b><span><div id="tipoMaquina"></div></span></p>

                    document.getElementById("tbMaquina-first").innerHTML += `<p><b>Sistema operacional: </b><span>${resposta[0].sistemaOperacional}</span></p>`;
                    document.getElementById("tbMaquina-first").innerHTML += `<p><b>Nome da máquina: </b><span>${resposta[0].nomeMaquina}</span></p>`;
                    document.getElementById("tbMaquina-first").innerHTML += `<p><b>Tipo da máquina: </b><span>${resposta[0].tipoMaquina}</span></p>`;
                    // Aqui coloca o status da máquina - desligada ou ligada
                    document.getElementById("tbMaquina-first").innerHTML += `<p><b>Status: </b><span>Desligada</span></p>`;
                    console.log(resposta)

                    // Aqui tem uma gambiarra pra funcionar mas é recomendavel que troque isso. Tava repetindo valores e as labels nao faziam sentido
                    for (let index = 0; index < resposta.length; index++) {

                        if (resposta[index].atributo == "CORE") {

                            resposta[index].unidadeMedida = "";
                            resposta[index].valor *= 1;
                            Math.trunc(resposta[index].valor)
                        }
                        if (resposta[index].atributo == "THREADS") {
                            resposta[index].unidadeMedida = "";
                            resposta[index].valor *= 1;
                            Math.trunc(resposta[index].valor)
                        }
                        document.getElementById("tbMaquina-sec").innerHTML += `<p><b>${resposta[index].tipoComponente} - ${resposta[index].atributo}: </b><span>${resposta[index].valor} ${resposta[index].unidadeMedida}</span></p>`;

                    }
                });
            }
        });


    }
</script>
<script src="./jsDash/script-dash.js"></script>
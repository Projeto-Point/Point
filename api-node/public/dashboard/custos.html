<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Análise de máquina | Point</title>
  <link rel="stylesheet" href="css/styleDashCustos.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>

<body>
  <header>
    <nav id="menu">
      <a href="maquinas.html" class="logo">
        <img src="../assets/imgs/Point.png">
      </a>
      <hr>
      <a href="funcionarios.html" class="img-nav">
        <img src="../assets/imgs/user.png">
        <span>Funcionários</span>
      </a>
      <a href="maquinas.html" class="img-nav">
        <img src="./assets/imgs/imac.png">
        <span>Máquinas</span>
      </a>
      <a href="instancias.html" class="img-nav">
        <img src="assets/dash/server.png">
        <span>Instâncias</span>
      </a>
      <a href="alertas.html" class="img-nav">
        <img src="assets/dash/alertas.png">
        <span>Alertas</span>
      </a>
      <a href="localizacao.html?filtroMapa=geral" class="img-nav">
        <img src="assets/imgs/pin.png">
        <span>Localização</span>
      </a>
      <a href="configuracoes.html" class="img-nav">
        <img src="./assets/imgs/setting.png">
        <span>Configurações</span>
      </a>
      <hr>
      <a class="img-nav" id="sair">
        <img src="../assets/imgs/x.png" />
        <span>Sair</span>
      </a>
    </nav>
    <nav id="menu-mobile"><img src="assets/dash/bars.svg" /></nav>
  </header>
  <main>
    <section class="top">
      <div class="top-esq">
        <p class="titulo">Olá, <span id="nome_gerente"></span></p>
        <p class="subtitulo">17/10/2022</p>
      </div>
      <div class="top-meio" style="visibility: hidden">
        <input id="inp-pesquisar-funcionario" type="search" placeholder="Pesquise o nome de um funcionário..." />
      </div>
      <div class="top-dir">
        <p class="nome"><span id="nomeGerente"></span></p>
        <img src="../assets/dash/icons8-user-64.png" />
      </div>
    </section>
    <section class="dashboard-analise">
      <div class="box box-kpi kpi-horas">
        <h3>Horas ativas:</h3>
        <p id="kpiHoras"></p>
      </div>
      <div class="box box-kpi kpi-mediaProc">
        <h3>Média do processador:</h3>
        <p id="kpiCPU">%</p>
      </div>
      <div class="box box-kpi kpi-mediaRam">
        <h3>Média da memória RAM:</h3>
        <p id="kpiRAM">%</p>
      </div>
      <div class="grafico-processador grafico box">
        <div class="header">
          <h3>Custos</h3>
          <div class="dir">
            <div></div>
            <span>Total: </span>
            <select id="tempoCpu" onchange="mudarTempo('CPU', this.value)">
              <option value="ultimoMes">Último mês</option>
              <option value="ultimaSemana">Última semana</option>
              <option value="ultimoAno">Último ano</option>
            </select>
          </div>
        </div>
        <div class="main-grafico">
          <canvas id="graficoCusto"></canvas>
        </div>
      </div>
      <div class="box info-maquina">
        <h3>Sobre a máquina</h3>
        <div id="sobreMaquina"></div>
        <br>
        <h3>Sobre o funcionário</h3>
        <div id="sobreFuncionario"></div>
      </div>
    </section>
  </main>
</body>

</html>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="../script.js"></script>
<script>
  nomeGerente.innerHTML = sessionStorage.NOME_USUARIO;
  nome_gerente.innerHTML = sessionStorage.NOME_USUARIO;

  const parametrosString = window.location.search;
  const parametros = new URLSearchParams(parametrosString);
  const idMaquina = Number(parametros.get("idMaquina"));



  fetch(`/medidas/pegarRegistroFuncionario?idMaquina=${idMaquina}`).then(
    function (res) {
      if (res.ok) {
        res.json().then((resposta) => {
          sobreFuncionario.innerHTML += `<p><b>Nome: </b>${resposta[0].nome}</p>`;
          sobreFuncionario.innerHTML += `<p><b>Cargo: </b>${resposta[0].cargo}</p>`;
          sobreFuncionario.innerHTML += `<p><b>E-mail: </b>${resposta[0].email}</p>`;
        });
      }
    }
  );

  fetch(`/maquinas/pegarKpis?idMaquina=${idMaquina}&dataInicio=${moment().subtract(30, "days").format("YYYY-MM-DD")}&dataFinal=${moment().format("YYYY-MM-DD")}`)
    .then((res) => {
      if (res.ok) {
        res.json().then((resposta) => {
          kpiCPU.innerHTML = resposta[0].mediaProcessador + "%";
          kpiRAM.innerHTML = resposta[0].mediaRAM + "%";
        });
      }
    })
    .catch((erro) => {
      console.log("Erro ao acessar /maquinas/pegarKpis");
      console.log(erro);
    });

  fetch(`/maquinas/pegarTempo?idMaquina=${idMaquina}&dataInicio=${moment().subtract(30, "days").format("YYYY-MM-DD")}&dataFinal=${moment().format("YYYY-MM-DD")}`)
    .then((res) => {
      if (res.ok) {
        res.json().then((resposta) => {
          let horariosDiferenca = [];

          resposta.forEach(item => {
            if (item.dataSaida != null) {
              let horarioEntrada = moment(item.dataEntrada).utc();
              let horarioSaida = moment(item.dataSaida).utc();
              horariosDiferenca.push(horarioSaida.diff(horarioEntrada));
            }
          });

          let horasAtivas = 0;
          horariosDiferenca.forEach(horario => {
            horasAtivas += horario;
          });

          let horas = moment.duration(horasAtivas).hours();
          let minutos = moment.duration(horasAtivas).minutes();

          if (horas == 1) {
            kpiHoras.innerHTML += horas;
            kpiHoras.innerHTML += " hora e "
          }
          else if (horas > 1) {
            kpiHoras.innerHTML += horas;
            kpiHoras.innerHTML += " horas e "
          }

          if (minutos == 1) {
            kpiHoras.innerHTML += minutos;
            kpiHoras.innerHTML += " minuto"
          }
          else if (minutos > 1) {
            kpiHoras.innerHTML += minutos;
            kpiHoras.innerHTML += " minutos"
          }
        });
      }
    })
    .catch((erro) => {
      console.log(erro);
    });






  fetch(`/grossizinho/pegarRegistroInstancia?idMaquina=${idMaquina}`).then((res) => {
    if (res.ok) {
      res.json().then((resposta) => {

        var preco = resposta.map((object) => object.preco);
        console.log(preco)
        console.log(resposta);


        document.getElementById(
          "sobreMaquina"
        ).innerHTML += `<p><b>Sistema operacional: </b><span>${resposta[0].sistemaOperacional}</span></p>`;
        document.getElementById(
          "sobreMaquina"
        ).innerHTML += `<p><b>Tipo da instância: </b><span>${resposta[0].nomeInstancia}</span></p>`;
        document.getElementById(
          "sobreMaquina"
        ).innerHTML += `<p><b>Custo por hora: </b><span>$${resposta[0].preco.toFixed(4)} USD</span></p>`;
        document.getElementById(
          "sobreMaquina"
        ).innerHTML += `<p><b>Performance em rede: </b><span>${resposta[0].performaceRede}</span></p>`;
        document.getElementById(
          "sobreMaquina"
        ).innerHTML += `<p><b>Armazenamento: </b><span>${resposta[0].tipoArmazenamento}</span></p>`;
        //   document.getElementById(
        //     "sobreMaquina"
        //   ).innerHTML += `<p><b>Alterar instância: </b><span class="top-esq"><a href="https://us-east-1.console.aws.amazon.com/console/home?region=us-east-1#" class="logo">teste
        // </a></span></p>`;




        fetch(`/maquinas/pegarTempo?idMaquina=${idMaquina}&dataInicio=${moment().subtract(30, "days").format("YYYY-MM-DD")}&dataFinal=${moment().format("YYYY-MM-DD")}`)
          .then((res) => {
            if (res.ok) {
              res.json().then((resposta) => {
                let horariosDiferenca = [];

                resposta.forEach(item => {
                  if (item.dataSaida != null) {
                    let horarioEntrada = moment(item.dataEntrada).utc();
                    let horarioSaida = moment(item.dataSaida).utc();
                    horariosDiferenca.push(horarioSaida.diff(horarioEntrada));
                  }
                });

                let horasAtivas = 0;
                horariosDiferenca.forEach(horario => {
                  horasAtivas += horario;
                });

                let horas = moment.duration(horasAtivas).hours();
                let minutos = moment.duration(horasAtivas).minutes();

              });
            }
          })
          .catch((erro) => {
            console.log(erro);
          });

      });
    }
  });

  fetch(`/grossizinho/entradaEsaida?idMaquina=${idMaquina}`).then(
    function (res) {
      if (res.ok) {
        res.json().then((resposta) => {
       
          var dia = resposta.map((object) => object.dataEntrada);
          console.log(dia[0])

          // var inicio = new Date(dia[0]);
          // var fim = new Date(dia[1]);

          // var diferenca = new Date(fim - inicio);

          // var resultado = diferenca.getUTCHours() + "h ";
          // resultado += diferenca.getUTCMinutes() + "m ";
          // resultado += diferenca.getUTCSeconds() + "s ";
          // console.log(resultado);



          const labels = dia;
          const data = {
            labels: labels,
            datasets: [
              {
                label: 'Dataset 1',
                data: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgb(75, 192, 192)',
                stack: 'combined',
                type: 'bar'
              },
              {
                label: 'Dataset 2',
                data: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgb(75, 192, 192)',
                stack: 'combined'
              }
            ]
          };

          const config = {
            type: 'line',
            data: data,
            options: {
              plugins: {
                title: {
                  display: false,
                }
              },
              scales: {
                y: {
                  stacked: true
                }
              }
            },
          };

          window.graficoCusto = new Chart(
            document.getElementById('graficoCusto').getContext("2d"),
            config);

        });
      }
    }
  );







</script>
<script src="./jsDash/script-dash.js"></script>